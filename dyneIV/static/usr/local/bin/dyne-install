#!/bin/zsh

function err() {
	>&2 echo "$0: $*"
}

dev="$1"
cmd="${2:-persist}"

[ "$dev" = "" ] && {
	>&2 echo "Usage: $0 /output/destination"
	>&2 echo "  will create a 'dyne' folder with your nest inside destination"
	exit 1
}

[ -r "$dev" ] || {
	err "device not found: $dev"
	exit 1
}

function mkiso() {
	mkdir -p "$dev/dyne"
	xorriso -as mkisofs -iso-level 3 -o "$dev"/dyne/dynebolic.iso \
        -full-iso9660-filenames -volid "DYNEIV" --mbr-force-bootable    \
        -partition_offset 16 -joliet -joliet-long -rational-rock        \
        -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin -eltorito-boot    \
        isolinux/isolinux.bin -no-emul-boot -boot-load-size 4           \
        -boot-info-table --eltorito-catalog isolinux/isolinux.cat       \
        -eltorito-alt-boot -e --interval:appended_partition_2:all::     \
        -no-emul-boot -isohybrid-gpt-basdat -append_partition 2         \
        `cat /proc/sys/kernel/random/uuid` \
        /var/run/live/medium/efiboot.img /var/run/live/medium         
}

function mkpersist() {
	# default 3.9GiB
	size=${size:-3900}
	[[ -n "$size"	]] || err "size argument missing, use -s"
	[[ $size == <-> ]] || err "size must be an integer (MB)"
	[[ $size -ge 512 ]] || err "size can't be smaller than 512 MB"
	persist="$dev/dyne/dyne.nst"
	err "creating nest of $size MiB in $persist"
	mkdir -p "$dev/dyne"
	dd if=/dev/zero of="$persist" \
	    bs=1048576 count="$size" oflag=direct status=progress
	loop=`losetup -f`
	losetup -f "$persist"
	mkfs.ext4 -L persistence "$loop"
	mkdir -p /mnt/dynebolic-persistence-temp
	mount "$loop" /mnt/dynebolic-persistence-temp
	cat << EOF > "/mnt/dynebolic-persistence-temp/persistence.conf"
/home union
/root union
/etc union
/var union
/usr union
EOF
	umount /mnt/dynebolic-persistence-temp
	rmdir /mnt/dynebolic-persistence-temp
	losetup -d "$loop"
}

case "$cmd" in
	init) ;;
	scan) ;;
	iso) mkiso ;;
	persist)
		[[ -r /run/live/persistence/loop1/persistence.conf ]] && \
			err "running system is already nested"
		[[ -r "${dev}"/dyne/dyne.nst ]] && {
			err "cannot overwrite nest: $dev/dyne/dyne.nst"
			exit 1
		}
		mkpersist
		err "--"
		err "nest succesfully created! reboot to activate."
		err "--"
		;;
	*)
		err "command not found: $cmd"
		exit 1 ;;
esac


