#!/bin/zsh

function err() {
	>&2 echo "$0: $*"
}

dev="$1"
cmd="${2:-diff}"

[ -z "$dev" ] && {
  >&2 echo "Usage: $0 /path/to/dyne.nst [ diff | ncdu | tar ]"
  exit 1
}
[ -r "$dev" ] || {
	err "device not found: $dev"
	exit 1
}

tmp=/mnt/dyne-nest-temporary
mkdir -p ${tmp}
case "$cmd" in
	diff)
		mount -o loop ${dev} ${tmp}
		tree ${tmp}/rw
		umount ${tmp}
		;;
	ncdu)
		mount -o loop ${dev} ${tmp}
		ncdu ${tmp}/rw
		umount ${tmp}
		;;
	tar)
		mount -o loop ${dev} ${tmp}
		tar -c -C ${tmp} rw | xz -v -z -T0 --memlimit-compress=70% \
			> dyne.nst.tar.xz
		umount ${tmp}
		;;
	*)
		err "command not found: $cmd"
		exit 1 ;;
esac
